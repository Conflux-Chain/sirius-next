{"version":3,"sources":["../../../src/utils/hooks/useGetTxnStatus.ts"],"sourcesContent":["import { useEffect, useState, useRef } from 'react';\n\nconst CFX = (window as any).CFX;\n\ninterface TxnLoopOptsType {\n  callback?: (data: any) => void;\n  timeout?: number;\n  method?: string;\n}\n\nexport const getTransactionLoop = function (\n  hash: string,\n  outOptions: TxnLoopOptsType,\n) {\n  const options = {\n    callback: () => {},\n    timeout: 2000,\n    method: 'getTransactionByHash',\n    ...outOptions,\n  };\n  return new Promise((resolve, reject) => {\n    const loop = function () {\n      const t = options.timeout;\n      CFX.cfx[options.method](hash)\n        .then((resp: any) => {\n          try {\n            if (resp) {\n              let status = null;\n              if (options.method === 'getTransactionByHash') {\n                status = resp && resp.status;\n              } else if (options.method === 'getTransactionReceipt') {\n                status = resp && resp.outcomeStatus;\n              }\n              options.callback(resp);\n              if (status !== 0) {\n                setTimeout(() => {\n                  loop();\n                }, t);\n              } else {\n                resolve(resp);\n                return resp;\n              }\n            } else {\n              setTimeout(() => {\n                loop();\n              }, t);\n            }\n          } catch (e) {\n            reject(e);\n          }\n        })\n        .catch(() => {\n          try {\n            setTimeout(() => {\n              loop();\n            }, t);\n          } catch (e) {\n            throw e;\n          }\n        });\n    };\n    loop();\n  });\n};\n\nexport const useGetTxnStatus = (\n  txnHashs: Array<string>,\n  timeout?: number, // timeout to polling txn status,\n  method?: any, // getTransactionByHash or getTransactionReceipt,\n) => {\n  // 0 for success, 1 for error occured, null when the transaction is skipped or not packed.\n  // eslint-disable-next-line react-hooks/rules-of-hooks\n  const [status, setStatus] = useState({});\n  const markedHashs: any = useRef({});\n\n  // eslint-disable-next-line react-hooks/rules-of-hooks\n  useEffect(() => {\n    const newHashs = txnHashs.filter(h => !markedHashs.current[h]);\n    if (newHashs.length) {\n      newHashs.forEach(h => {\n        markedHashs.current[h] = true;\n        getTransactionLoop(h, {\n          callback: resp => {\n            setStatus((statusMap: { [key: string]: any }) => {\n              const markedHashsKeys = Object.keys(markedHashs.current);\n              const updatedStatusMap = markedHashsKeys.reduce(\n                (prev: { [key: string]: any }, curr) => {\n                  prev[curr] = statusMap[curr];\n                  return prev;\n                },\n                {},\n              );\n              updatedStatusMap[h] = resp?.status;\n              return updatedStatusMap;\n            });\n          },\n          timeout: timeout || 2000,\n          method: method || 'getTransactionByHash',\n        });\n      });\n    }\n  });\n\n  return {\n    status,\n  };\n};\n"],"mappings":";AAAA,SAAS,WAAW,UAAU,cAAc;AAE5C,IAAM,MAAO,OAAe;AAQrB,IAAM,qBAAqB,SAChC,MACA,YACA;AACA,QAAM,UAAU;AAAA,IACd,UAAU,MAAM;AAAA,IAAC;AAAA,IACjB,SAAS;AAAA,IACT,QAAQ;AAAA,IACR,GAAG;AAAA,EACL;AACA,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,UAAM,OAAO,WAAY;AACvB,YAAM,IAAI,QAAQ;AAClB,UAAI,IAAI,QAAQ,MAAM,EAAE,IAAI,EACzB,KAAK,CAAC,SAAc;AACnB,YAAI;AACF,cAAI,MAAM;AACR,gBAAI,SAAS;AACb,gBAAI,QAAQ,WAAW,wBAAwB;AAC7C,uBAAS,QAAQ,KAAK;AAAA,YACxB,WAAW,QAAQ,WAAW,yBAAyB;AACrD,uBAAS,QAAQ,KAAK;AAAA,YACxB;AACA,oBAAQ,SAAS,IAAI;AACrB,gBAAI,WAAW,GAAG;AAChB,yBAAW,MAAM;AACf,qBAAK;AAAA,cACP,GAAG,CAAC;AAAA,YACN,OAAO;AACL,sBAAQ,IAAI;AACZ,qBAAO;AAAA,YACT;AAAA,UACF,OAAO;AACL,uBAAW,MAAM;AACf,mBAAK;AAAA,YACP,GAAG,CAAC;AAAA,UACN;AAAA,QACF,SAAS,GAAG;AACV,iBAAO,CAAC;AAAA,QACV;AAAA,MACF,CAAC,EACA,MAAM,MAAM;AACX,YAAI;AACF,qBAAW,MAAM;AACf,iBAAK;AAAA,UACP,GAAG,CAAC;AAAA,QACN,SAAS,GAAG;AACV,gBAAM;AAAA,QACR;AAAA,MACF,CAAC;AAAA,IACL;AACA,SAAK;AAAA,EACP,CAAC;AACH;AAEO,IAAM,kBAAkB,CAC7B,UACA,SACA,WACG;AAGH,QAAM,CAAC,QAAQ,SAAS,IAAI,SAAS,CAAC,CAAC;AACvC,QAAM,cAAmB,OAAO,CAAC,CAAC;AAGlC,YAAU,MAAM;AACd,UAAM,WAAW,SAAS,OAAO,OAAK,CAAC,YAAY,QAAQ,CAAC,CAAC;AAC7D,QAAI,SAAS,QAAQ;AACnB,eAAS,QAAQ,OAAK;AACpB,oBAAY,QAAQ,CAAC,IAAI;AACzB,2BAAmB,GAAG;AAAA,UACpB,UAAU,UAAQ;AAChB,sBAAU,CAAC,cAAsC;AAC/C,oBAAM,kBAAkB,OAAO,KAAK,YAAY,OAAO;AACvD,oBAAM,mBAAmB,gBAAgB;AAAA,gBACvC,CAAC,MAA8B,SAAS;AACtC,uBAAK,IAAI,IAAI,UAAU,IAAI;AAC3B,yBAAO;AAAA,gBACT;AAAA,gBACA,CAAC;AAAA,cACH;AACA,+BAAiB,CAAC,IAAI,MAAM;AAC5B,qBAAO;AAAA,YACT,CAAC;AAAA,UACH;AAAA,UACA,SAAS,WAAW;AAAA,UACpB,QAAQ,UAAU;AAAA,QACpB,CAAC;AAAA,MACH,CAAC;AAAA,IACH;AAAA,EACF,CAAC;AAED,SAAO;AAAA,IACL;AAAA,EACF;AACF;","names":[]}